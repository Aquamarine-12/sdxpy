<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sd4ds">
  <meta name="build_date" content="2023-05-12">
  <meta name="template" content="default">
  <meta name="major" content="Chapter 7">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design for Data Scientists: Functions and Closures</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design for Data Scientists</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      A Test Runner
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      <strong>Functions and Closures</strong>
    </a>
  </li>
  
  <li>
    <a href="../mock/">
      Mock Objects
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../flow/">
      A Pipeline Runner
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../server/">
      A Web Server
    </a>
  </li>
  
  <li>
    <a href="../editor/">
      A Text Editor
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sd4ds-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 7: Functions and Closures</h1>


          
<div class="draft">
  <p>DRAFT</p>
</div>
<div class="center">
  <p>
    <em>Please use section heading links to submit feedback.</em>
  </p>
</div>


          
  

  

  

  

  

  

  

  


          
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a>, <a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a>, <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensibility</a>, <a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a>, <a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a>
</p>


          <div class="page-toc"></div>
          <h2 id="interpreter-functions">Section 7.1: Functions</h2>
<p>One way to evaluate the design of a piece of software is
to ask how <a class="gl-ref" href="../glossary/#extensibility" markdown="1">extensible</a> it is,
i.e.,
how easily we can add or change things <span class="bib-ref">[<a class="bib-ref" href="../bibliography/#Wilson2022a">Wilson2022a</a>]</span>.
The answer for our interpreter is now, &ldquo;Pretty easily,&rdquo;
but for our little language is, &ldquo;Not at all,&rdquo;
because there&rsquo;s no way for users to create new operations of their own.
We need to give users a way to define and call functions.</p>
<p>Doing this takes less than 60 lines:</p>
<ol>
<li>
<p>A function definition looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">&quot;def&quot;</span><span class="p">,</span> <span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;num&quot;</span><span class="p">]]</span>
</code></pre></div>
<p>It has a name, a (possibly empty) list of parameter names,
and a single instruction as a body
(which will usually be a <code>"seq"</code> instruction).</p>
</li>
<li>
<p>Functions are stored in the environment like any other value.
    The value stored for the function defined above would be:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;num&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;num&quot;</span><span class="p">]]</span>
</code></pre></div>
<p>We don&rsquo;t need to store the name: that&rsquo;s recorded by the environment,
just like it is for any other variable.</p>
</li>
<li>
<p>A function call looks like:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="s2">&quot;call&quot;</span><span class="p">,</span> <span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></div>
<p>The values passed to the functions are normally expressions rather than constants,
and are <em>not</em> put in a sub-list.
The implementation:
1.  Evaluates all of these expressions.
2.  Looks up the function.
3.  Creates a new environment whose keys are the parameters&rsquo; names
    and whose values are the expressions&rsquo; values.
4.  Calls <code>do</code> to run the function&rsquo;s action and captures the result.
5.  Discards environment created two steps previously.
6.  Returns the function&rsquo;s result.</p>
</li>
<li>
<p>Instead of using a single dictionary to store an environment
    we use a list of dictionaries.
    The first dictionary is the global environment;
    the others store the variables belonging to active function calls.</p>
</li>
<li>
<p>When we get or set a variable,
    we check the most recent environment first
    (i.e., the one that&rsquo;s last in the list);
    if the variable isn&rsquo;t there we look in the global environment.
    We don&rsquo;t look at the environments in between;
    the exercises explore why not.</p>
</li>
</ol>
<div class="callout">
<h3>Scoping rules</h3>
<p>The set of active environments makes up the program&rsquo;s
<span class="ix-entry" ix-key="call stack" markdown="1"><a class="gl-ref" href="../glossary/#call_stack" markdown="1">call stack</a></span>.
For historical reasons,
each environment is sometimes called a <span class="ix-entry" ix-key="call stack!stack frame;stack frame" markdown="1"><a class="gl-ref" href="../glossary/#stack_frame" markdown="1">stack frame</a></span>.
Searching through all active stack frames for a variable
is called is <span class="ix-entry" ix-key="dynamic scoping;scoping!dynamic" markdown="1"><a class="gl-ref" href="../glossary/#dynamic_scoping" markdown="1">dynamic scoping</a></span>.
In contrast,
most programming languages used <span class="ix-entry" ix-key="lexical scoping;scoping!lexical" markdown="1"><a class="gl-ref" href="../glossary/#lexical_scoping" markdown="1">lexical scoping</a></span>,
which figures out what a variable name refers to based on the structure of the program text.</p>
</div>
<p>Here&rsquo;s the implementation of <code>do_def</code>:</p>
<div class="code-sample lang-py" title="func.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_def</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">env_set</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;func&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">body</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<p class="continue">And here&rsquo;s the implementation of <code>do_call</code>:</p>
<div class="code-sample lang-py" title="func.py">
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">do_call</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="c1"># Set up the call.</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>

    <span class="c1"># Find the function.</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">env_get</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">func</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;func&quot;</span><span class="p">)</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">func</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="c1"># Run in new environment.</span>
    <span class="n">env</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">values</span><span class="p">)))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
    <span class="n">env</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="c1"># Report.</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p class="continue">Our test program and its output are:</p>
<div class="code-sample lang-tll" title="func.tll">
<div class="highlight"><pre><span></span><code>[&quot;seq&quot;,
  [&quot;def&quot;, &quot;double&quot;, [&quot;num&quot;],
    [&quot;add&quot;, [&quot;get&quot;, &quot;num&quot;], [&quot;get&quot;, &quot;num&quot;]]
  ],
  [&quot;set&quot;, &quot;a&quot;, 1],
  [&quot;repeat&quot;, 4, [&quot;seq&quot;,
    [&quot;set&quot;, &quot;a&quot;, [&quot;call&quot;, &quot;double&quot;, [&quot;get&quot;, &quot;a&quot;]]],
    [&quot;print&quot;, [&quot;get&quot;, &quot;a&quot;]]
  ]]
]
</code></pre></div>
</div>
<div class="code-sample lang-out" title="func.out">
<div class="highlight"><pre><span></span><code>2
4
8
16
=&gt; None
</code></pre></div>
</div>
<p>Once again,
Python and other languages work exactly as shown here.
The interpreter
(or the CPU, if we&rsquo;re running code compiled to machine instructions)
reads an instruction,
figures out what operation it corresponds to,
and executes that operation.</p>
        </main>
      </div>
    </div>
  </body>
</html>
