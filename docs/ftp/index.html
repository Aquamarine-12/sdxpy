<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="repo" content="https://github.com/gvwilson/sd4ds">
  <meta name="build_date" content="2023-06-02">
  <meta name="template" content="default">
  <meta name="major" content="Chapter 21">
  <meta name="has_slides" content="true">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design for Data Scientists: Transferring Files</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <img src="../logo.svg" alt="site logo" class="logo" />
  <a href="../">Software Design for Data Scientists</a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../intro/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../dup/">
      Finding Duplicate Files
    </a>
  </li>
  
  <li>
    <a href="../glob/">
      Matching Patterns
    </a>
  </li>
  
  <li>
    <a href="../parse/">
      Parsing Text
    </a>
  </li>
  
  <li>
    <a href="../test/">
      A Test Runner
    </a>
  </li>
  
  <li>
    <a href="../interp/">
      An Interpreter
    </a>
  </li>
  
  <li>
    <a href="../func/">
      Functions and Closures
    </a>
  </li>
  
  <li>
    <a href="../mock/">
      Mock Objects
    </a>
  </li>
  
  <li>
    <a href="../archive/">
      A File Archiver
    </a>
  </li>
  
  <li>
    <a href="../oop/">
      Objects and Classes
    </a>
  </li>
  
  <li>
    <a href="../check/">
      An HTML Validator
    </a>
  </li>
  
  <li>
    <a href="../template/">
      A Template Expander
    </a>
  </li>
  
  <li>
    <a href="../lint/">
      A Code Linter
    </a>
  </li>
  
  <li>
    <a href="../layout/">
      Page Layout
    </a>
  </li>
  
  <li>
    <a href="../perf/">
      Performance Profiling
    </a>
  </li>
  
  <li>
    <a href="../persist/">
      Object Persistence
    </a>
  </li>
  
  <li>
    <a href="../binary/">
      Binary Data
    </a>
  </li>
  
  <li>
    <a href="../db/">
      A Database
    </a>
  </li>
  
  <li>
    <a href="../build/">
      A Build Manager
    </a>
  </li>
  
  <li>
    <a href="../pack/">
      A Package Manager
    </a>
  </li>
  
  <li>
    <a href="../ftp/">
      <strong>Transferring Files</strong>
    </a>
  </li>
  
  <li>
    <a href="../http/">
      Serving Web Pages
    </a>
  </li>
  
  <li>
    <a href="../editor/">
      A Text Editor
    </a>
  </li>
  
  <li>
    <a href="../undo/">
      Undo and Redo
    </a>
  </li>
  
  <li>
    <a href="../vm/">
      A Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      A Debugger
    </a>
  </li>
  
  <li>
    <a href="../finale/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../bib/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../syllabus/">
      Syllabus
    </a>
  </li>
  
  <li>
    <a href="../slides/">
      Slides
    </a>
  </li>
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contrib/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../credits/">
      Credits
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sd4ds-examples.zip" type="application/zip">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 21: Transferring Files</h1>


          
<div class="draft">
  <p>DRAFT</p>
</div>
<div class="center">
  <p>
    <em>Please use section heading links to submit feedback.</em>
  </p>
</div>


          
  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
  <ul class="syllabus">
  
  <li markdown="1">Every computer on a network has a unique IP address.</li>
  
  <li markdown="1">The Domain Name System (DNS) translates human-readable names into IP addresses.</li>
  
  <li markdown="1">The programs on each computer send and receive messages through numbered sockets.</li>
  
  <li markdown="1">The program that receives a message must interpret the bytes in the message.</li>
  
  </ul>
  

  

  

  


          
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#client" markdown="1">client</a>, <a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System</a>, <a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol</a>, <a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a>, <a class="gl-ref" href="../glossary/#port" markdown="1">port</a>, <a class="gl-ref" href="../glossary/#server" markdown="1">server</a>, <a class="gl-ref" href="../glossary/#socket" markdown="1">socket</a>, <a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol</a>
</p>


          <div class="page-toc"></div>
          <p>The Internet is simpler than most people realize
(as well as being more complex than anyone could possibly comprehend).
Most systems still follow the rules they did thirty years ago;
in particular,
most web servers still handle the same kinds of messages in the same way.</p>
<h2 id="ftp-tcpip">Section 21.1: Using TCP/IP</h2>
<p>Pretty much every program on the web
runs on a family of communication standards called
<span class="ix-entry" ix-key="Internet Protocol (IP);IP (Internet Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#internet_protocol" markdown="1">Internet Protocol (IP)</a></span>.
The one that concerns us is the
<span class="ix-entry" ix-key="Transmission Control Protocol (TCP/IP);TCP/IP (Transmission Control Protocol)" markdown="1"><a class="gl-ref" href="../glossary/#tcp" markdown="1">Transmission Control Protocol (TCP/IP)</a></span>,
which makes communication between computers look like reading and writing files.</p>
<p>Programs using IP communicate through <span class="ix-entry" ix-key="socket" markdown="1"><a class="gl-ref" href="../glossary/#socket" markdown="1">sockets</a></span>
(<a class="fig-ref" href="../ftp/#ftp-sockets">Figure 21.1</a>).
Each socket is one end of a point-to-point communication channel,
just like a phone is one end of a phone call.
A socket consists of an <span class="ix-entry" ix-key="IP address" markdown="1"><a class="gl-ref" href="../glossary/#ip_address" markdown="1">IP address</a></span> that identifies a particular machine
and a <span class="ix-entry" ix-key="port" markdown="1"><a class="gl-ref" href="../glossary/#port" markdown="1">port</a></span> on that machine.</p>
<figure id="ftp-sockets">
<img src="./sockets.svg" alt="Sockets, IP addresses, and DNS"/>
<figcaption markdown="1">Figure 21.1: How sockets, IP addresses, and DNS work together.</figcaption>
</figure>

<p>The IP address consists of four 8-bit numbers,
which are usually written as <code>93.184.216.34</code>;
the <span class="ix-entry" ix-key="Domain Name System (DNS);DNS (Domain Name System)" markdown="1"><a class="gl-ref" href="../glossary/#dns" markdown="1">Domain Name System (DNS)</a></span>
matches these numbers to symbolic names like <code>example.com</code>
that are easier for human beings to remember.</p>
<p>A port is a number in the range 0-65535
that uniquely identifies the socket on the host machine.
(If an IP address is like a company&rsquo;s phone number,
then a port number is like an extension.)
Ports 0-1023 are reserved for well-known TCP/IP applications like web servers;
custom applications should use the remaining ports
(and should allow users to decide <em>which</em> port,
since there&rsquo;s always the chance that two different people will pick 1234 or 6789).</p>
<p>Most web applications consists of <span class="ix-entry" ix-key="client (web application)" markdown="1"><a class="gl-ref" href="../glossary/#client" markdown="1">clients</a></span>
and <span class="ix-entry" ix-key="server (web application)" markdown="1"><a class="gl-ref" href="../glossary/#server" markdown="1">servers</a></span>.
A client program initiates communication by sending a message and waiting for a response;
a server,
on the other hand,
waits for requests and the replies to them.
There are typically many more clients than servers:
for example,
there may be hundreds or thousands of browsers
fetching pages from this book&rsquo;s website right now,
but there is only one server handling those requests.</p>
<p>Here&rsquo;s a basic socket client:</p>
<div class="code-sample lang-py" title="client.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;message text&quot;</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client sent </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes&quot;</span><span class="p">)</span>

<span class="n">received</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
<span class="n">received_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">received</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;client received </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">received</span><span class="p">)</span><span class="si">}</span><span class="s2"> bytes: &#39;</span><span class="si">{</span><span class="n">received_str</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</code></pre></div>
</div>
<p class="continue">We call it &ldquo;basic&rdquo; rather than &ldquo;simple&rdquo; because there&rsquo;s a lot going on here.
From top to bottom, this code:</p>
<ol>
<li>Imports some modules and defines some constants.
    The most interesting of these is <code>SERVER_ADDRESS</code>
    consisting of a host identifier and a port.
    The string <code>"localhost"</code> means &ldquo;the current machine&rdquo;.</li>
<li>We use <code>socket.socket</code> to create a new socket.
    The values <code>AF_INET</code> and <code>SOCK_STREAM</code> specify the protocols we&rsquo;re using;
    we&rsquo;ll always use those in our examples,
    so we won&rsquo;t go into details about them.</li>
<li>We connect to the server…</li>
<li>…send our message as a bunch of bytes with <code>sock.sendall</code>…</li>
<li>…and print a message saying the data&rsquo;s been sent.</li>
<li>We then read up to a kilobyte from the socket with <code>sock.recv</code>.
    If we were expecting longer messages,
    we&rsquo;d keep reading from the socket until there was no more data.</li>
<li>Finally, we print another message.</li>
</ol>
<p>The corresponding server has just as much low-level detail:</p>
<div class="code-sample lang-py" title="raw_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">():</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostbyname</span><span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">),</span> <span class="mi">8080</span>
    <span class="n">server_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">server_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>

    <span class="n">server_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="n">server_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection from </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">),</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;got request from </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">This code claims a socket,
listens until it receives a connection request,
reads up to a kilobyte of data,
prints a message,
and replies to the client.
<a class="fig-ref" href="../ftp/#ftp-interaction">Figure 21.2</a> shows the order of operations and messages
when we run the client and server in separate terminal windows.</p>
<figure id="ftp-interaction">
<img src="./interaction.svg" alt="Client/server interaction"/>
<figcaption markdown="1">Figure 21.2: Steps and messages in client/server interaction.</figcaption>
</figure>

<div class="callout">
<h3>Testing Multiprocess Applications</h3>
<p>Testing single-process command-line applications is hard enough;
to test a client-server application,
we have to start the server,
wait for it to be ready,
then run the client,
and then shut down the server if it hasn&rsquo;t shut down by itself.
It&rsquo;s easy to do this interactively,
but automating it is difficult because
there&rsquo;s no way to tell how long to wait before trying to talk to the server
and no easy way to shut the server down.
We will explore some approaches once we have a larger application to test.</p>
</div>
<p>There&rsquo;s a <em>lot</em> going on here,
so most people who have to program at this level
use Python&rsquo;s <code>socketserver</code> library,
which provides two things:
a class called <code>TCPServer</code> that manages incoming connections
and another class called <code>BaseRequestHandler</code>
that does everything <em>except</em> process the incoming data.
In order to do that,
we derive a class of our own from <code>BaseRequestHandler</code> that provides a <code>handle</code> method.
Every time <code>TCPServer</code> gets a new connection
it creates a new object of our class
and calls that object&rsquo;s <code>handle</code> method.
Using these,
our server is:</p>
<div class="code-sample lang-py" title="lib_server.py">
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">socketserver</span>

<span class="n">KILOBYTE</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="n">SERVER_ADDRESS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">8080</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">socketserver</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">KILOBYTE</span><span class="p">)</span>
        <span class="n">cli</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;got request from </span><span class="si">{</span><span class="n">cli</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">server</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">SERVER_ADDRESS</span><span class="p">,</span> <span class="n">MyHandler</span><span class="p">)</span>
    <span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
</div>
<p class="continue">These two library classes use a different design than what we&rsquo;ve seen before.
Instead of creating one class for programmers to extend,
the <code>socketserver</code> library puts the low-level details in <code>TCPServer</code>,
which can be used as-is,
and asks users to create a plug-in class from <code>BaseRequestHandler</code>
for the server to use.
This approach isn&rsquo;t intrinsically better or worse than
the &ldquo;derive and override&rdquo; approach we&rsquo;ve seen before;
they&rsquo;re just two more tools in a software designer&rsquo;s toolbox.</p>
<h2 id="ftp-summary">Section 21.2: Summary</h2>
<figure id="ftp-concept-map">
<img src="./concept_map.svg" alt="File transfer concept map"/>
<figcaption markdown="1">Figure 21.3: File transfer concept map.</figcaption>
</figure>

<h2 id="ftp-exercises">Section 22.6: Exercises</h2>
<p><span class="fixme">FIXME exercises</span></p>
        </main>
      </div>
    </div>
  </body>
</html>
